#!/bin/sh 
#
# $Id$
#
# use to check whether ser is still responding; if not mail an alert
#


NOTIFY=sr@iptel.org
SERHOME=/home/srouter
SERDIR=$SERHOME/sip_router
TESTDIR=$SERDIR/test
BIN=$TESTDIR/sipsak
SIPURI=sip:sipsak@iptel.org
LOCKDIR=/var/lock
LOCKFILE=serresponse
LOCK_TIMEOUT=240
TMP=/tmp/serresponse.$$
MAILCOMMAND=/bin/mail

############################

LOCKF=$LOCKDIR/$LOCKFILE

if [ -e $LOCKF ] ; then
	find $LOCKDIR -name $LOCKFILE -amin +$LOCK_TIMEOUT -exec rm {} ';'
	if [ ! -e $LOCKF ] ; then
		echo "This is a reminder !!!" > $TMP
		echo "The lockfile $LOCKF" >> $TMP
		echo "was just removed because ist was older then $LOCK_TIMEOUT minutes." >> $TMP
		echo "But if you receive this mail the cause of this error still exists or respawned." >> $TMP
	fi
fi

if [ ! -e $LOCKF ] ; then
	if [ ! -x $BIN ] ; then
		echo "serresponse did not find the required sipsak executable $BIN" >> $TMP
	else
		echo "The execution of this command:" >> $TMP
		echo "  $BIN -s $SIPURI" >> $TMP
		echo "produced this output:" >> $TMP
		$BIN -s $SIPURI >> $TMP 2>&1
		if [ $? -eq 0 ] ; then
			rm -f $TMP
		fi
	fi
	
	if [ -e $TMP ] ; then
		$MAILCOMMAND -s "serresponse failed" $NOTIFY < $TMP
		touch $LOCKF
		rm -f $TMP
	fi
fi
