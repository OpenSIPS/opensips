#
# configuration for TurboSIP testing
#
# $ID: $
#

debug=1          # debug level (cmd line: -dddddddddd)
fork=yes          # (cmd. line: -D)
#fork=no
#log_stderror=yes # (cmd line: -E)
log_stderror=no	# (cmd line: -E)


children=8
check_via=yes     # (cmd. line: -v)
dns=on           # (cmd. line: -r)
rev_dns=yes      # (cmd. line: -R)
port=5080
#listen=127.0.0.1
listen=195.37.77.101
loop_checks=0
# for more info: sip_router -h

#modules
loadmodule "modules/print/print.so"
#loadmodule "modules/tm/tm.so"

#route[0]{
#	if (method=="BYE") { forward("bat.iptel.org", 5000); }
#	else forward("bat.iptel.org", 5090);
#	break;
#}

route[0]{
	log("SER: new request reveived\n");
	if ( t_lookup_request()) {
		if ( method=="ACK" )	{
			log("SER: ACK for an existing transaction received\n");
			if (! t_forward("bat.iptel.org", "5090" )) {
				log("SER: WARNING: bad forward\n");
			} else log("SER: t_forward ok\n");
			if (! t_release()) {
				log("SER: WARNING: bad t_release\n");
			} else log("SER: t_release ok\n");
		} else {
			if (method=="INVITE" ) { log("SER: it's an INVITE retranmission\n"); }
			else if (method=="BYE") log( "SER: it's a BYE retransmission\n")
			else log("SER: it's a retransmission (neither INVITE nor BYE\n");
			if (! t_retransmit_reply()) {
				log("SER: WARNING: bad t_retransmit_reply\n");
			} else log("SER: t_retransmit ok\n");
		};
		t_unref();
	} else {
		log("SER: transaction not found\n");
		if (method=="ACK") {
			# no established transaction ... forward ACK just statelessly
			log("SER: ACK received\n");
			forward("bat.iptel.org", 5090);
		} else {
			# establish transaction
			log("SER: adding new transaction\n");
			if (method=="INVITE" ) { log("SER: it's a new INVITE \n"); }
			else if (method=="BYE") log( "SER: it's a new BYE \n")
			else log("SER: it is a new transaction (neither INVITE nor BYE)\n");
			if (! t_add_transaction()){
				log("SER t_add_transaction failed\n");
			} else log("SER: t_add_Transactio ok\n");
			# reply
			if (method=="CANCEL") {
				log("SER: new CANCEL\n");
				if (! t_send_reply( "200", "glad to cancel")){
					log("SER:ERROR: t_send_reply\n");
				};
			} else {
				log("SER: replying\n");
				if (! t_send_reply("100", "Trying")
					){
					log("SER: ERROR: t_send_reply (100)\n");
				} else log("SER: t_send_reply ok\n");
			};
			if (method=="INVITE") {
				if (! t_forward("bat.iptel.org", "5090")){
					log("SER:ERROR: t_forward (..., 5555)\n");
				} else log("SER: t_forward ok\n");
			} else if (method=="BYE") {
				if (! t_forward("bat.iptel.org", "5000")){
					log("SER:ERROR: t_forward (..., 5555)\n");
				} else log("SER: t_forward ok\n");
			} else log("SER: ERROR unknwon request\n");
			t_unref();
		};
	};
}
