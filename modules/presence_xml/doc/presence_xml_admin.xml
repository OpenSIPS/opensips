<!-- Module User's Guide -->

<chapter>
	
	<title>&adminguide;</title>
	
	<section>
	<title>Overview</title>
	<para> 
	The module does specific handling for notify-subscribe events using xml bodies.
	It is used with the general event handling module, presence. It constructs and adds
	3 events to it: presence, presence.winfo, dialog;sla. 
	</para>
	<para>
	This module takes the xcap permission rule documents from xcap_table.

	The presence permission rules are interpreted according to the specifications
	in RFC 4745 and RFC 5025.
	</para>
	</section>

	<section>
	<title>Dependencies</title>
	<section>
		<title>&osips; Modules</title>
		<para>
		The following modules must be loaded before this module:
			<itemizedlist>
			<listitem>
			<para>
				<emphasis>a database module</emphasis>.
			</para>
			</listitem>
			<listitem>
			<para>
				<emphasis>presence</emphasis>.
			</para>
			</listitem>
			<listitem>
			<para>
				<emphasis>signaling</emphasis>.
			</para>
			</listitem>
			<listitem>
			<para>
				<emphasis>xcap_client</emphasis>.
			</para>
			<para>
			Only compulsory if not using an integrated xcap server 
			(if 'integrated_xcap_server' parameter is not set).
			</para>
			</listitem>

			</itemizedlist>
		</para>
	</section>

	<section>
		<title>External Libraries or Applications</title>
		<para>
		The following libraries or applications must be installed before running
		&osips; with this module loaded:
			<itemizedlist>
			<listitem>
			<para>
				<emphasis>libxml-dev</emphasis>.
			</para>
			</listitem>
			</itemizedlist>
		</para>
	</section>
	</section>
	
	<section>
	<title>Exported Parameters</title>
	<section>
		<title><varname>db_url</varname>(str)</title>
		<para>
		The database url.
		</para>
		<para>
		<emphasis>	Default value is <quote>&defaultdb;</quote>.	
		</emphasis>
		</para>
		<example>
		<title>Set <varname>db_url</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "db_url", "&exampledb;")
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>xcap_table</varname>(str)</title>
		<para>
		The name of the db table where XCAP documents are stored.
		</para>
		<para>
		<emphasis>	Default value is <quote>xcap</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>xcap_table</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "xcap_table", "xcaps")
...
</programlisting>
		</example>
	</section>

	<section>
		<title><varname>force_active</varname> (int)</title>
		<para>
		This parameter is used for permissions when handling Subscribe messages.
		If set to 1, subscription state is considered active and the presentity
		is not queried for permissions(should be set to 1 if not using an xcap 
		server). 
		Otherwise,the xcap server is queried and the subscription states is
		according to user defined permission rules. If no rules are defined for
		a certain watcher, the subscriptions remains in pending state and the
		Notify sent will have no body.
		</para>
		<para>
		Note: When switching from one value to another, the watchers table must
		be emptied.
		</para>
		<para>
		<emphasis>Default value is <quote>0</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>force_active</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "force_active", 1)
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>pidf_manipulation</varname> (int)</title>
		<para>
		Setting this parameter to 1 enables the features described in RFC 4827.
		It gives the possibility to have a permanent state notified to the users
		even in the case in which the phone is not online. The presence document
		is taken from the xcap server and aggregated together with the other
		presence information, if any exist, for each Notify that is sent to the
		watchers. It is also possible to have information notified even if not 
		issuing any Publish (useful for services such as email, SMS, MMS).
		</para>
		<para>
		<emphasis>Default value is <quote>0</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>pidf_manipulation</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "pidf_manipulation", 1)
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>integrated_xcap_server</varname> (int)</title>
		<para>
		This parameter is a flag for the type of XCAP server or servers 
		used. If integrated ones, like XCAP-lite from AG Projects, 
		with direct access to database table, the parameter should be
		set to a positive value. Apart from updating in xcap table,
		the integrated server must send an MI command refershWatchers 
		[pres_uri] [event] when a user modifies a rules document. 
		</para>
		<para>
		Otherwise, it uses xcap_client module to fetch documents 
		from the XCAP servers with HTTP requests.</para>
		<para>
		<emphasis>Default value is <quote>0</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>integrated_xcap_server</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "integrated_xcap_server", 1)
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>merge</varname> (int)</title>
		<para>
                Some presentities can publish different (R)PIDF presence documents.
                In that case, the default behavior is to notify subscribers with an
                aggregated presence document. However, some UAs do not support
                receiving aggregated presence documents containing different presence
                states and randomly choose one to display to the user. To prevent this,
                it is possible to ask the presence server to merge the various presence
                documents and always notify the most up to date document to the subscribers.
		</para>
                <para>
                For example, if a UA publishes a first document valid for 60 minutes
                indicating the presentity is available, and another UA publishes a second
                document for the same presentity indicating it is away, subscribers will
                be notified with the away state until it expires and the available state
                is valid again.
                </para>
		<emphasis>Default value is <quote>0</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>merge</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "merge", 1)
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>merge_primary_source</varname> (str)</title>
		<para>
                Allows a specific presence source to have priority over others even
                if it is not the last one having been published.
                The <quote>merge_primary_source</quote> string needs to appear in
                the tuple id for the source to be recognized as primary.
		</para>
                <para>
                Requires the <quote>merge</quote> parameter to be set to 1.
                </para>
		<emphasis>Default value is <quote>primary</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>merge_primary_source</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "merge_primary_source", "calendar")
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>cachedb_url</varname> (str)</title>
		<para>
                Allows caching the RPIDF activities and note elements in
                the cachedb database.
                If there is no RPIDF, stores the basic element or
                the im element values.
		</para>
                <para>
                It allows presence based routing.
		</para>
                <para>
                Requires the <quote>merge</quote> parameter to be set to 1.
                </para>
		<emphasis>Default value is <quote>empty</quote>.
		</emphasis>
		</para>
		<example>
		<title>Set <varname>cachedb_url</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "cachedb_url", "db://")
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>xcap_server</varname> (str)</title>
		<para>
		The address of the xcap servers used for storage.
		This parameter is compulsory if the integrated_xcap_server parameter
		is not set. It can be set more that once, to construct an address
		list of trusted XCAP servers.</para>
		<example>
		<title>Set <varname>xcap_server</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "xcap_server", "xcap_server.example.org")
modparam("presence_xml", "xcap_server", "xcap_server.ag.org")
...
</programlisting>
		</example>
	</section>
	<section>
		<title><varname>pres_rules_auid</varname> (str)</title>
		<para>
		This parameter should be configured if you are using the non integrated xcap
		mode and you need to use another pres-rules auid than the default 'pres-rules'.
		</para>
		<example>
		<title>Set <varname>pres_rules_auid</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "pres_rules_auid", "org.openmobilealliance.pres-rules")
...
</programlisting>
		</example>
	</section>

	<section>
		<title><varname>pres_rules_filename</varname> (str)</title>
		<para>
		This parameter should be configured if you are using the non integrated xcap
		mode and you need to configure another filename than the default 'index'.
		</para>
		<example>
		<title>Set <varname>pres_rules_filename</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "pres_rules_filename", "pres-rules")
...
</programlisting>
		</example>
	</section>

	<section>
		<title><varname>generate_offline_body</varname> (str)</title>
		<para>
                This parameter should be set to 0 if you want to prevent OpenSIPS from automatically
                generating a PIDF body when a publication expires or is explicitly terminated
                (a PUBLISH request is received with Expires: 0).
		</para>
		<example>
		<title>Set <varname>generate_offline_body</varname> parameter</title>
		<programlisting format="linespecific">
...
modparam("presence_xml", "generate_offline_body", 0)
...
</programlisting>
		</example>
	</section>



</section>
<section>
	<title>Exported Functions</title>
	<para>
	None to be used in configuration file.
	</para>
</section>

<section>
	<title>Installation</title>
	<para>
	The module requires 1 table in OpenSIPS database: xcap. The SQL 
	syntax to create it can be found in presence-create.sql     
	script in the database directories in the opensips/scripts folder.
	You can also find the complete database documentation on the
	project webpage, &osipsdbdocs;.
	</para>
</section>

</chapter>

